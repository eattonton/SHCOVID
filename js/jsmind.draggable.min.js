(function(t){"use strict";var e=t.document,i="jsMind",s=t[i];if(s&&void 0===s.draggable){var n=s.util.dom,o="getSelection"in t?function(){t.getSelection().removeAllRanges()}:function(){e.selection.empty()},a={line_width:5,lookup_delay:500,lookup_interval:80};s.draggable=function(t){this.jm=t,this.e_canvas=null,this.canvas_ctx=null,this.shadow=null,this.shadow_w=0,this.shadow_h=0,this.active_node=null,this.target_node=null,this.target_direct=null,this.client_w=0,this.client_h=0,this.offset_x=0,this.offset_y=0,this.hlookup_delay=0,this.hlookup_timer=0,this.capture=!1,this.moved=!1},s.draggable.prototype={init:function(){this._create_canvas(),this._create_shadow()},resize:function(){this.jm.view.e_nodes.appendChild(this.shadow),this.e_canvas.width=this.jm.view.size.w,this.e_canvas.height=this.jm.view.size.h},_create_canvas:function(){var t=e.createElement("canvas");this.jm.view.e_panel.appendChild(t);var i=t.getContext("2d");this.e_canvas=t,this.canvas_ctx=i},_create_shadow:function(){var t=e.createElement("jmnode");t.style.visibility="hidden",t.style.zIndex="3",t.style.cursor="move",t.style.opacity="0.7",this.shadow=t},reset_shadow:function(t){var e=this.shadow.style;this.shadow.innerHTML=t.innerHTML,e.left=t.style.left,e.top=t.style.top,e.width=t.style.width,e.height=t.style.height,e.backgroundImage=t.style.backgroundImage,e.backgroundSize=t.style.backgroundSize,e.transform=t.style.transform,this.shadow_w=this.shadow.clientWidth,this.shadow_h=this.shadow.clientHeight},show_shadow:function(){this.moved||(this.shadow.style.visibility="visible")},hide_shadow:function(){this.shadow.style.visibility="hidden"},_magnet_shadow:function(t){t&&(this.canvas_ctx.lineWidth=a.line_width,this.canvas_ctx.strokeStyle="rgba(0,0,0,0.3)",this.canvas_ctx.lineCap="round",this._clear_lines(),this._canvas_lineto(t.sp.x,t.sp.y,t.np.x,t.np.y))},_clear_lines:function(){this.canvas_ctx.clearRect(0,0,this.jm.view.size.w,this.jm.view.size.h)},_canvas_lineto:function(t,e,i,s){this.canvas_ctx.beginPath(),this.canvas_ctx.moveTo(t,e),this.canvas_ctx.lineTo(i,s),this.canvas_ctx.stroke()},_lookup_close_node:function(){var t,e,i=this.jm.get_root(),n=i.get_location(),o=i.get_size(),h=n.x+o.w/2,l=this.shadow_w,d=this.shadow_h,c=this.shadow.offsetLeft,_=this.shadow.offsetTop,r=c+l/2>=h?s.direction.right:s.direction.left,u=this.jm.mind.nodes,v=null,f=this.jm.layout,m=Number.MAX_VALUE,w=0,g=null,p=null,y=null;for(var x in u){var k,b;if(v=u[x],v.isroot||v.direction==r){if(v.id==this.active_node.id)continue;if(!f.is_visible(v))continue;if(t=v.get_size(),e=v.get_location(),r==s.direction.right){if(c-e.x-t.w<=0)continue;w=Math.abs(c-e.x-t.w)+Math.abs(_+d/2-e.y-t.h/2),k={x:e.x+t.w-a.line_width,y:e.y+t.h/2},b={x:c+a.line_width,y:_+d/2}}else{if(e.x-c-l<=0)continue;w=Math.abs(c+l-e.x)+Math.abs(_+d/2-e.y-t.h/2),k={x:e.x+a.line_width,y:e.y+t.h/2},b={x:c+l-a.line_width,y:_+d/2}}w<m&&(g=v,p=k,y=b,m=w)}}var j=null;return g&&(j={node:g,direction:r,sp:y,np:p}),j},lookup_close_node:function(){var t=this._lookup_close_node();t&&(this._magnet_shadow(t),this.target_node=t.node,this.target_direct=t.direction)},_event_bind:function(){var t=this,e=this.jm.view.container;n.add_event(e,"mousedown",function(e){var i=e||event;t.dragstart.call(t,i)}),n.add_event(e,"mousemove",function(e){var i=e||event;t.drag.call(t,i)}),n.add_event(e,"mouseup",function(e){var i=e||event;t.dragend.call(t,i)}),n.add_event(e,"touchstart",function(e){var i=e||event;t.dragstart.call(t,i)}),n.add_event(e,"touchmove",function(e){var i=e||event;t.drag.call(t,i)}),n.add_event(e,"touchend",function(e){var i=e||event;t.dragend.call(t,i)})},dragstart:function(e){if(this.jm.get_editable()&&!this.capture){this.active_node=null;var i=this.jm.view,s=e.target||event.srcElement;if("jmnode"==s.tagName.toLowerCase()){var n=i.get_binded_nodeid(s);if(n){var o=this.jm.get_node(n);if(!o.isroot){this.reset_shadow(s),this.active_node=o,this.offset_x=(e.clientX||e.touches[0].clientX)/i.actualZoom-s.offsetLeft,this.offset_y=(e.clientY||e.touches[0].clientY)/i.actualZoom-s.offsetTop,this.client_hw=Math.floor(s.clientWidth/2),this.client_hh=Math.floor(s.clientHeight/2),0!=this.hlookup_delay&&t.clearTimeout(this.hlookup_delay),0!=this.hlookup_timer&&t.clearInterval(this.hlookup_timer);var h=this;this.hlookup_delay=t.setTimeout(function(){h.hlookup_delay=0,h.hlookup_timer=t.setInterval(function(){h.lookup_close_node.call(h)},a.lookup_interval)},a.lookup_delay),this.capture=!0}}}}},drag:function(t){if(this.jm.get_editable()&&this.capture){t.preventDefault(),this.show_shadow(),this.moved=!0,o();var e=this.jm.view,i=(t.clientX||t.touches[0].clientX)/e.actualZoom-this.offset_x,s=(t.clientY||t.touches[0].clientY)/e.actualZoom-this.offset_y;this.shadow.style.left=i+"px",this.shadow.style.top=s+"px",o()}},dragend:function(e){if(this.jm.get_editable()){if(this.capture){if(0!=this.hlookup_delay&&(t.clearTimeout(this.hlookup_delay),this.hlookup_delay=0,this._clear_lines()),0!=this.hlookup_timer&&(t.clearInterval(this.hlookup_timer),this.hlookup_timer=0,this._clear_lines()),this.moved){var i=this.active_node,s=this.target_node,n=this.target_direct;this.move_node(i,s,n)}this.hide_shadow()}this.moved=!1,this.capture=!1}},move_node:function(t,e,i){var n=this.shadow.offsetTop;if(e&&t&&!s.node.inherited(t,e)){for(var o=e.children,a=o.length,h=null,l=Number.MAX_VALUE,d=null,c="_last_";a--;)if(h=o[a],h.direction==i&&h.id!=t.id){var _=h.get_location().y-n;_>0&&_<l&&(l=_,d=h,c="_first_")}d&&(c=d.id),this.jm.move_node(t.id,c,e.id,i)}this.active_node=null,this.target_node=null,this.target_direct=null},jm_event_handle:function(t,e){t===s.event_type.resize&&this.resize()}};var h=new s.plugin("draggable",function(t){var e=new s.draggable(t);e.init(),t.add_event_listener(function(t,i){e.jm_event_handle.call(e,t,i)})});s.register_plugin(h)}})(window);